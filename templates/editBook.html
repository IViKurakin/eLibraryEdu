{% extends 'base.html' %}

{% block title %}Редактировать книгу - Электронная библиотека{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'contri' user.id %}">Мои книги</a></li>
<li class="breadcrumb-item"><a href="{% url 'viewBook' book.id %}">{{ book.title|truncatechars:30 }}</a></li>
<li class="breadcrumb-item active">Редактировать</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow border-0">
            <div class="card-header bg-warning text-white py-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-pencil-square display-5 me-3"></i>
                    <div>
                        <h2 class="h4 mb-0">Редактировать книгу</h2>
                        <p class="mb-0 opacity-75">Внесите изменения в информацию о книге</p>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-4 p-md-5">
                <div class="current-book-info mb-5">
                    <div class="card border-warning">
                        <div class="card-header bg-warning bg-opacity-10 border-warning">
                            <i class="bi bi-book me-2 text-warning"></i>Текущие данные книги
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="mb-2">{{ book.title }}</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1">
                                                <strong><i class="bi bi-person me-2 text-muted"></i>Автор:</strong> 
                                                {{ book.author }}
                                            </p>
                                            <p class="mb-1">
                                                <strong><i class="bi bi-tag me-2 text-muted"></i>Категория:</strong>
                                                <span class="badge 
                                                    {% if book.category == 'Education' %}bg-primary
                                                    {% elif book.category == 'Fiction' %}bg-success
                                                    {% elif book.category == 'Science' %}bg-warning
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ book.category }}
                                                </span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1">
                                                <strong><i class="bi bi-file-text me-2 text-muted"></i>Страниц:</strong> 
                                                {{ book.pages }}
                                            </p>
                                            <p class="mb-0">
                                                <strong><i class="bi bi-calendar me-2 text-muted"></i>Добавлена:</strong>
                                                {{ book.created_at|date:"d.m.Y" }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <a href="{{ book.pdf.url }}" target="_blank" class="btn btn-outline-primary">
                                        <i class="bi bi-file-pdf me-2"></i>Текущий PDF
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-2">Ошибки при заполнении формы</h5>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                    <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endif %}

                <form method="POST" action="{% url 'editBook' book.id %}" enctype="multipart/form-data" id="editBookForm">
                    {% csrf_token %}
                    
                    <ul class="nav nav-tabs mb-4" id="editTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" 
                                    data-bs-target="#basic" type="button">
                                <i class="bi bi-info-circle me-2"></i>Основная информация
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="file-tab" data-bs-toggle="tab" 
                                    data-bs-target="#file" type="button">
                                <i class="bi bi-file-earmark-pdf me-2"></i>Файл книги
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" 
                                    data-bs-target="#advanced" type="button">
                                <i class="bi bi-gear me-2"></i>Дополнительно
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="editTabsContent">
                        <div class="tab-pane fade show active" id="basic" role="tabpanel">
                            <div class="row">
                                <div class="col-md-12 mb-4">
                                    <label for="id_title" class="form-label fw-semibold">
                                        Название книги <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-book"></i></span>
                                        <input type="text" class="form-control" id="id_title" name="title" 
                                               maxlength="150" required
                                               value="{{ form.title.value|default:book.title }}">
                                    </div>
                                    <div class="form-text text-end">
                                        <span id="title-counter">{{ book.title|length }}</span>/150 символов
                                    </div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label for="id_author" class="form-label fw-semibold">Автор</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                                        <input type="text" class="form-control" id="id_author" 
                                               value="{{ book.author }}" readonly>
                                    </div>
                                    <div class="form-text">Авторство изменить нельзя</div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label for="id_pages" class="form-label fw-semibold">
                                        Количество страниц <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-file-text"></i></span>
                                        <input type="number" class="form-control" id="id_pages" name="pages" 
                                               min="1" max="9999" required
                                               value="{{ form.pages.value|default:book.pages }}">
                                        <span class="input-group-text">страниц</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="id_category" class="form-label fw-semibold mb-3">
                                    Категория книги <span class="text-danger">*</span>
                                </label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="card category-option h-100 {% if book.category == 'Education' %}border-primary{% endif %}" 
                                             onclick="selectCategory('Education')">
                                            <div class="card-body text-center">
                                                <i class="bi bi-mortarboard display-6 text-primary mb-3"></i>
                                                <h5 class="card-title">Образование</h5>
                                                <p class="card-text small text-muted">Учебники, пособия, методички</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card category-option h-100 {% if book.category == 'Fiction' %}border-success{% endif %}" 
                                             onclick="selectCategory('Fiction')">
                                            <div class="card-body text-center">
                                                <i class="bi bi-palette display-6 text-success mb-3"></i>
                                                <h5 class="card-title">Художественная</h5>
                                                <p class="card-text small text-muted">Романы, рассказы, поэзия</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card category-option h-100 {% if book.category == 'Science' %}border-warning{% endif %}" 
                                             onclick="selectCategory('Science')">
                                            <div class="card-body text-center">
                                                <i class="bi bi-flask display-6 text-warning mb-3"></i>
                                                <h5 class="card-title">Научная</h5>
                                                <p class="card-text small text-muted">Исследования, монографии, статьи</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="id_category" name="category" value="{{ book.category }}" required>
                            </div>

                            <div class="mb-4">
                                <label for="id_summary" class="form-label fw-semibold">
                                    Аннотация <span class="text-danger">*</span>
                                </label>
                                <div class="form-floating">
                                    <textarea class="form-control" id="id_summary" name="summary" 
                                              maxlength="2000" style="height: 150px" required>{{ form.summary.value|default:book.summary }}</textarea>
                                    <label for="id_summary">Опишите содержание книги, основные идеи, тематику...</label>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <div class="form-text">
                                        Рекомендуется: 150-500 символов
                                    </div>
                                    <div class="form-text">
                                        <span id="summary-counter">{{ book.summary|length }}</span>/2000 символов
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="file" role="tabpanel">
                            <div class="current-file mb-4">
                                <div class="card border-success">
                                    <div class="card-header bg-success bg-opacity-10 border-success">
                                        <i class="bi bi-file-pdf text-success me-2"></i>Текущий файл
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="bi bi-file-earmark-pdf-fill text-danger me-2"></i>
                                                    {{ book.pdf.name|cut:"pdfs/"|truncatechars:40 }}
                                                </h6>
                                                <p class="text-muted small mb-0">
                                                    Загружен: {{ book.created_at|date:"d.m.Y" }}
                                                </p>
                                            </div>
                                            <div class="btn-group">
                                                <a href="{{ book.pdf.url }}" class="btn btn-outline-primary btn-sm" 
                                                   target="_blank">
                                                    <i class="bi bi-eye"></i> Просмотр
                                                </a>
                                                <a href="{{ book.pdf.url }}" class="btn btn-outline-success btn-sm" 
                                                   download>
                                                    <i class="bi bi-download"></i> Скачать
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="id_pdf" class="form-label fw-semibold">
                                    Заменить PDF файл
                                </label>
                                <div class="alert alert-info">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle fs-4 me-3"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Не обязательно</h6>
                                            <p class="mb-0 small">
                                                Оставьте поле пустым, чтобы сохранить текущий файл.
                                                Если загрузите новый файл, старый будет заменен.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="file-upload-area border rounded-3 p-5 text-center mb-3">
                                    <i class="bi bi-cloud-arrow-up display-3 text-muted mb-3"></i>
                                    <h5>Перетащите новый PDF файл</h5>
                                    <p class="text-muted">или</p>
                                    <input type="file" class="form-control d-none" id="id_pdf" name="pdf" 
                                           accept=".pdf">
                                    <button type="button" class="btn btn-outline-primary" 
                                            onclick="document.getElementById('id_pdf').click()">
                                        <i class="bi bi-folder2-open me-2"></i>Выбрать файл
                                    </button>
                                    <div class="mt-3">
                                        <small class="text-muted">Максимальный размер: 10MB</small>
                                    </div>
                                </div>
                                
                                <div id="file-info" class="d-none">
                                    <div class="alert alert-warning d-flex align-items-center">
                                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                                        <div>
                                            <h6 class="mb-1">Новый файл выбран</h6>
                                            <p class="mb-0 small" id="file-name"></p>
                                            <p class="mb-0 small text-muted" id="file-size"></p>
                                            <p class="mb-0 small text-danger">
                                                <i class="bi bi-exclamation-circle me-1"></i>
                                                Текущий файл будет заменен
                                            </p>
                                        </div>
                                        <button type="button" class="btn-close ms-auto" onclick="clearFile()"></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="advanced" role="tabpanel">
                            <div class="mb-4">
                                <label class="form-label fw-semibold mb-3">Дополнительные настройки</label>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="update_date">
                                    <label class="form-check-label" for="update_date">
                                        Обновить дату последнего изменения
                                    </label>
                                    <div class="form-text">
                                        Дата обновится до текущей после сохранения
                                    </div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="send_notification">
                                    <label class="form-check-label" for="send_notification">
                                        Уведомить подписчиков об изменениях
                                    </label>
                                    <div class="form-text">
                                        Пользователи, добавившие книгу в избранное, получат уведомление
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-shield-exclamation fs-4 me-3"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Важно!</h6>
                                            <p class="mb-0 small">
                                                Все изменения будут видны другим пользователям библиотеки.
                                                Проверьте информацию перед сохранением.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-top pt-4 mt-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{% url 'viewBook' book.id %}" class="btn btn-outline-secondary me-2">
                                    <i class="bi bi-eye me-1"></i>Просмотр
                                </a>
                                <a href="{% url 'contri' user.id %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>К списку
                                </a>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-danger me-2" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteModal">
                                    <i class="bi bi-trash me-1"></i>Удалить
                                </button>
                                <button type="submit" class="btn btn-warning btn-lg">
                                    <i class="bi bi-check-circle me-2"></i>Сохранить изменения
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    Подтверждение удаления
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-trash fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Внимание!</h6>
                            <p class="mb-0 small">Это действие нельзя отменить.</p>
                        </div>
                    </div>
                </div>
                
                <p>Вы уверены, что хотите удалить книгу <strong>"{{ book.title }}"</strong>?</p>
                <p class="text-muted small">Книга будет полностью удалена из библиотеки.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Отмена
                </button>
                <a href="{% url 'deleteBook' book.id %}" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i>Удалить книгу
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .category-option {
        cursor: pointer;
        transition: all 0.3s;
    }
    .category-option:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .file-upload-area {
        border: 2px dashed #dee2e6;
        transition: all 0.3s;
    }
    .file-upload-area:hover {
        border-color: var(--bs-primary);
        background: rgba(13, 110, 253, 0.05);
    }
    
    .current-book-info .card {
        border-width: 2px;
    }
    
    .nav-tabs .nav-link {
        padding: 12px 20px;
        font-weight: 500;
    }
    .nav-tabs .nav-link.active {
        background-color: rgba(255, 193, 7, 0.1);
        border-color: var(--bs-warning) var(--bs-warning) transparent;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const titleInput = document.getElementById('id_title');
        const summaryInput = document.getElementById('id_summary');
        const titleCounter = document.getElementById('title-counter');
        const summaryCounter = document.getElementById('summary-counter');
        
        function updateCounters() {
            titleCounter.textContent = titleInput.value.length;
            summaryCounter.textContent = summaryInput.value.length;
        }
        
        titleInput.addEventListener('input', updateCounters);
        summaryInput.addEventListener('input', updateCounters);
        updateCounters();
        
        function selectCategory(category) {
            document.getElementById('id_category').value = category;
            document.querySelectorAll('.category-option').forEach(el => {
                el.classList.remove('border-primary', 'border-success', 'border-warning');
            });
            const selectedCard = document.querySelector(`[onclick="selectCategory('${category}')"]`);
            selectedCard.classList.add(
                category === 'Education' ? 'border-primary' :
                category === 'Fiction' ? 'border-success' : 'border-warning'
            );
        }
        
        selectCategory('{{ book.category }}');
        
        const fileInput = document.getElementById('id_pdf');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const uploadArea = document.querySelector('.file-upload-area');
        
        fileInput.addEventListener('change', function() {
            if (this.files.length) {
                const file = this.files[0];
                const maxSize = 10 * 1024 * 1024; // 10MB
                
                if (file.type !== 'application/pdf') {
                    alert('Пожалуйста, выберите файл в формате PDF.');
                    this.value = '';
                    return;
                }
                
                if (file.size > maxSize) {
                    alert('Файл слишком большой. Максимальный размер: 10MB.');
                    this.value = '';
                    return;
                }
                
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.classList.remove('d-none');
                uploadArea.classList.add('d-none');
            }
        });
        
        if (uploadArea) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-primary');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                this.classList.remove('border-primary');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-primary');
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            });
        }
        
        let formChanged = false;
        const form = document.getElementById('editBookForm');
        const formInputs = form.querySelectorAll('input, textarea, select');
        
        formInputs.forEach(input => {
            const originalValue = input.value;
            input.addEventListener('input', function() {
                if (this.value !== originalValue) {
                    formChanged = true;
                }
            });
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = 'У вас есть несохраненные изменения. Вы уверены, что хотите покинуть страницу?';
            }
        });
        
        form.addEventListener('submit', function() {
            formChanged = false;
        });
    });
    
    function clearFile() {
        document.getElementById('id_pdf').value = '';
        document.getElementById('file-info').classList.add('d-none');
        document.querySelector('.file-upload-area').classList.remove('d-none');
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
{% endblock %}